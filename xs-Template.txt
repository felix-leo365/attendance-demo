// ==UserScript==
// @name         ğŸŒ¸ XServer VPS ç»­æœŸåŠ©æ‰‹ (Sakura V2.0)
// @namespace    XSERVER-RENEW-VPS
// @version      2.0
// @description  XS-VPSä¸“ç”¨
// @author       é›¶Â·è®¡åˆ’ç ”ç©¶æ‰€ğŸ‘¾-C4
// @match        https://secure.xserver.ne.jp/*
// @connect      api.telegram.org
// @connect      captcha-120546510085.asia-northeast1.run.app
// @grant        GM_xmlhttpRequest
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_addStyle
// @run-at       document-idle
// ==/UserScript==

(async function() {
    'use strict';

    //===========================================================================
    //  âš™ï¸âš™ï¸âš™ï¸ ç”¨æˆ·é…ç½® (è„šæœ¬ä½œè€…ï¼šé›¶Â·è®¡åˆ’ç ”ç©¶æ‰€ğŸ‘¾-C4) âš™ï¸âš™ï¸âš™ï¸
    //===========================================================================
    const CONFIG = {
        // ğŸŸ¢ è´¦å·ä¿¡æ¯ (å¿…å¡«)
        EMAIL: "",      // ä¾‹å¦‚: your_email@example.com
        PASSWORD: "",   // ä¾‹å¦‚: your_password

        // ğŸ”µ Telegram æ¨é€é…ç½® (é€‰å¡«ï¼Œä¸å¡«åˆ™ä¸æ¨é€)
        TG_TOKEN: "",   // ä¾‹å¦‚: 123456789:ABCDefGhI...
        TG_ID: "",      // ä¾‹å¦‚: 12345678

        // ğŸŸ¡ ç³»ç»Ÿé…ç½®
        CAPTCHA_API: "https://captcha-120546510085.asia-northeast1.run.app",
        LOGIN_URL: "https://secure.xserver.ne.jp/xapanel/login/xvps"
    };
    //===========================================================================


    //===================== æ ¸å¿ƒçŠ¶æ€ç®¡ç† ======================//
    const STORE = {
        get logs() { return GM_getValue('xs_logs', []); },
        set logs(val) { GM_setValue('xs_logs', val.slice(-50)); },
        get lastRunDate() { return GM_getValue('xs_last_run_date', ''); },
        set lastRunDate(val) { GM_setValue('xs_last_run_date', val); },
        get nextRunDate() { return GM_getValue('xs_next_run_date', ''); },
        set nextRunDate(val) { GM_setValue('xs_next_run_date', val); },
        
        get isPaused() { return GM_getValue('xs_is_paused', false); },
        set isPaused(val) { GM_setValue('xs_is_paused', val); },
        get forceRun() { return GM_getValue('xs_force_run', false); },
        set forceRun(val) { GM_setValue('xs_force_run', val); },
        get expiryDate() { return GM_getValue('xs_expiry_date', 'æœªçŸ¥'); },
        set expiryDate(val) { GM_setValue('xs_expiry_date', val); }
    };

    //===================== å·¥å…·å‡½æ•° ======================//
    const wait = ms => new Promise(r => setTimeout(r, ms));
    
    function formatDate(rawStr) {
        if (!rawStr) return "æœªçŸ¥";
        const match = rawStr.match(/(\d{4})[-./å¹´](\d{1,2})[-./æœˆ](\d{1,2})/);
        if (match) {
            const y = match[1];
            const m = match[2].padStart(2, '0');
            const d = match[3].padStart(2, '0');
            return `${y}-${m}-${d}`;
        }
        return rawStr;
    }

    function sendTg(text) {
        if (!CONFIG.TG_TOKEN || !CONFIG.TG_ID) return;
        
        const today = getBeijingDate().dateStr;
        const msg = `ğŸŒ¸ <b>XServer VPS ç»­æœŸåŠ©æ‰‹</b>\n\n` +
                    `ğŸš€ <b>è¿è¡Œæ—¥æœŸ:</b> ${today}\n` +
                    `ğŸ“… <b>ä¸‹æ¬¡ç»­æœŸ:</b> ${STORE.nextRunDate || 'æœªçŸ¥'}\n` + 
                    `â³ <b>åˆ©ç”¨æœŸé™:</b> ${STORE.expiryDate}\n` +
                    `ğŸ“ <b>ç»­æœŸç»“æœ:</b> ${text}\n` +
                    `ğŸ“§ <b>å½“å‰è´¦å·:</b> ${CONFIG.EMAIL}`;

        const url = `https://api.telegram.org/bot${CONFIG.TG_TOKEN}/sendMessage?chat_id=${CONFIG.TG_ID}&text=${encodeURIComponent(msg)}&parse_mode=HTML`;
        GM_xmlhttpRequest({ method: "GET", url: url, onerror: (e) => console.error("TG Fail", e) });
    }

    const getBeijingDate = () => {
        const d = new Date();
        const utc = d.getTime() + (d.getTimezoneOffset() * 60000);
        const bjDate = new Date(utc + (3600000 * 8));
        const y = bjDate.getFullYear();
        const m = String(bjDate.getMonth() + 1).padStart(2, '0');
        const day = String(bjDate.getDate()).padStart(2, '0');
        return {
            full: bjDate,
            dateStr: `${y}-${m}-${day}`,
            hour: bjDate.getHours()
        };
    };

    async function ocrSolve(imgDataUrl) {
        return new Promise(resolve => {
            GM_xmlhttpRequest({
                method: "POST",
                url: CONFIG.CAPTCHA_API,
                headers: { "Content-Type": "text/plain" },
                data: imgDataUrl,
                onload: r => {
                    let match = r.responseText.match(/\d+/);
                    resolve(match ? match[0] : "");
                },
                onerror: () => resolve("")
            });
        });
    }

    function extractNextAllowedDate() {
        try {
            const bodyText = document.body.innerText;
            let match = bodyText.match(/(\d{4})[-./å¹´](\d{1,2})[-./æœˆ](\d{1,2})æ—¥?.*ã‹ã‚‰.*å¯èƒ½/);
            if (!match) {
                match = bodyText.match(/åˆ©ç”¨ã‚’ç¶™ç¶šã•ã‚Œã‚‹å ´åˆã¯[ã€,\s]*(\d{4})[-./å¹´](\d{1,2})[-./æœˆ](\d{1,2})/);
            }
            if (match) return formatDate(match[0]);
        } catch(e) { console.error("æ’æœŸæå–é”™è¯¯", e); }
        return null;
    }

    function extractExactExpiry() {
        try {
            const allElements = Array.from(document.querySelectorAll('th, td, dt, dd, div'));
            const labelEl = allElements.find(el => el.innerText.includes("åˆ©ç”¨æœŸé™") && el.children.length === 0);
            
            if (labelEl) {
                const parentRow = labelEl.parentElement; 
                if (parentRow) {
                    const rowText = parentRow.innerText;
                    const dateMatch = rowText.match(/20\d{2}[-./å¹´]\d{1,2}[-./æœˆ]\d{1,2}/);
                    if (dateMatch) return formatDate(dateMatch[0]);
                }
            }
            const classEl = document.querySelector(".contract__term");
            if (classEl && classEl.innerText.match(/20\d{2}/)) {
                return formatDate(classEl.innerText.trim());
            }
        } catch(e) { console.error("æ—¥æœŸæå–é”™è¯¯", e); }
        return null;
    }

    function extractNewExpiryFromConf() {
        try {
            const ths = Array.from(document.querySelectorAll('th'));
            const targetTh = ths.find(th => th.innerText.includes('æ›´æ–°å¾Œã®åˆ©ç”¨æœŸé™'));
            if (targetTh) {
                const td = targetTh.nextElementSibling; 
                if (td) return formatDate(td.innerText.trim());
            }
        } catch(e) { console.error("æ–°æ—¥æœŸæå–é”™è¯¯", e); }
        return null;
    }

    //===================== UI é¢æ¿ç³»ç»Ÿ ======================//
    const UI = {
        init() {
            GM_addStyle(`
                #xs-panel { 
                    position: fixed; bottom: 20px; right: 20px; width: 280px; 
                    background: rgba(255, 255, 255, 0.98); 
                    color: #444; 
                    z-index: 99999; 
                    border-radius: 12px; 
                    box-shadow: 0 5px 25px rgba(255, 183, 178, 0.5); 
                    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                    font-size: 13px; 
                    transition: all 0.3s; 
                    border: 1px solid #ffd1d1;
                }
                #xs-header { 
                    padding: 10px 15px; 
                    background: linear-gradient(135deg, #ff9a9e 0%, #ffc3a0 100%); 
                    border-radius: 12px 12px 0 0; 
                    display: flex; justify-content: space-between; align-items: center; 
                    cursor: pointer; 
                    color: #fff; text-shadow: 0 1px 1px rgba(0,0,0,0.1);
                    font-weight: 600;
                }
                #xs-title { font-size: 13px; letter-spacing: 0.5px; }
                #xs-content { padding: 12px; max-height: 400px; overflow-y: auto; }
                .xs-row { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; gap: 5px; line-height: 1.5; }
                .xs-label { color: #666; font-size: 12px; }
                .xs-val { font-family: "SF Mono", "Consolas", "Liberation Mono", Menlo, monospace; font-weight: bold; color: #333; font-size: 13px; }
                .xs-btn { flex: 1; padding: 6px 2px; border: none; border-radius: 6px; cursor: pointer; color: white; font-weight: 600; transition: all 0.2s; font-size: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
                .xs-btn:hover { opacity: 0.9; transform: translateY(-1px); }
                .btn-start { background: #00b894; background-image: linear-gradient(to right, #00b894, #55efc4); }
                .btn-pause { background: #ff7675; background-image: linear-gradient(to right, #ff7675, #fab1a0); }
                .btn-run { background: #6c5ce7; background-image: linear-gradient(to right, #6c5ce7, #a29bfe); }
                .btn-clear { background: #dfe6e9; color: #636e72; border: 1px solid #b2bec3; flex: 0.5; box-shadow: none; }
                #xs-logs { height: 130px; overflow-y: scroll; background: #fff5f7; padding: 8px; border: 1px solid #ffe3e3; border-radius: 8px; font-family: "SF Mono", "Consolas", "Liberation Mono", monospace; white-space: pre-wrap; margin-top: 10px; color: #555; font-size: 11px; }
                .log-line { margin: 3px 0; border-bottom: 1px dashed #ffd1ff; padding-bottom: 2px; }
                .log-time { color: #ff6b6b; margin-right: 6px; }
                .hl-date { color: #e17055; }
                #xs-logs::-webkit-scrollbar { width: 4px; }
                #xs-logs::-webkit-scrollbar-thumb { background: #ffb7b2; border-radius: 2px; }
            `);

            const panel = document.createElement('div');
            panel.id = 'xs-panel';
            panel.innerHTML = `
                <div id="xs-header">
                    <span id="xs-title">ğŸŒ¸ XS-VPS V2.0</span>
                    <span id="xs-status">Checking...</span>
                </div>
                <div id="xs-content">
                    <div class="xs-row">
                        <span class="xs-label">ğŸš€ è¿è¡Œæ—¥æœŸ</span>
                        <span id="xs-last-run" class="xs-val">${STORE.lastRunDate || 'æ— è®°å½•'}</span>
                    </div>
                    <div class="xs-row">
                        <span class="xs-label">ğŸ“… ä¸‹æ¬¡ç»­æœŸ</span>
                        <span id="xs-next-run" class="xs-val" style="color:#a29bfe;">${STORE.nextRunDate || 'æ— è®¡åˆ’'}</span>
                    </div>
                    <div class="xs-row">
                        <span class="xs-label">â³ åˆ©ç”¨æœŸé™</span>
                        <span id="xs-expiry" class="xs-val hl-date">${STORE.expiryDate}</span>
                    </div>
                    <div class="xs-row" style="margin-top:10px;">
                        <button id="xs-toggle-btn" class="xs-btn ${STORE.isPaused ? 'btn-start' : 'btn-pause'}">
                            ${STORE.isPaused ? 'â–¶ ç»§ç»­' : 'â¸ æš‚åœ'}
                        </button>
                        <button id="xs-run-btn" class="xs-btn btn-run">ğŸš€ ç«‹å³è¿è¡Œ</button>
                        <button id="xs-clear-btn" class="xs-btn btn-clear">æ¸…ç©º</button>
                    </div>
                    <div id="xs-logs"></div>
                </div>
            `;
            document.body.appendChild(panel);

            document.getElementById('xs-toggle-btn').onclick = () => {
                STORE.isPaused = !STORE.isPaused;
                location.reload();
            };
            document.getElementById('xs-clear-btn').onclick = () => {
                STORE.logs = [];
                UI.renderLogs();
            };
            document.getElementById('xs-run-btn').onclick = () => {
                if(confirm('âš ï¸ ç¡®å®šè¦å¼ºåˆ¶æ‰§è¡Œä¸€æ¬¡å—ï¼Ÿ\nè¿™å°†å¿½ç•¥æ—¶é—´å’Œä»Šæ—¥è®°å½•ï¼Œç«‹å³å¼€å§‹ã€‚')) {
                    STORE.forceRun = true;
                    STORE.lastRunDate = "";
                    STORE.nextRunDate = ""; 
                    STORE.isPaused = false;
                    UI.log("ğŸš€ æŒ‡ä»¤å·²æ¥æ”¶: å‡†å¤‡å¼ºåˆ¶è¿è¡Œ...");
                    setTimeout(() => { location.href = CONFIG.LOGIN_URL; }, 500);
                }
            };

            UI.renderLogs();
            UI.updateStatus();
        },

        log(msg) {
            const currentLogs = STORE.logs;
            const lastEntry = currentLogs[currentLogs.length - 1] || "";
            const lastContentMatch = lastEntry.match(/^\[.*?\] (.*)/);
            const lastContent = lastContentMatch ? lastContentMatch[1] : "";

            if (msg === lastContent) return; 

            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false });
            const logEntry = `[${timeStr}] ${msg}`;
            
            console.log(logEntry);
            currentLogs.push(logEntry);
            STORE.logs = currentLogs;
            UI.renderLogs();
        },

        renderLogs() {
            const container = document.getElementById('xs-logs');
            if(!container) return;
            container.innerHTML = STORE.logs.map(l => {
                const parts = l.match(/^\[(.*?)\] (.*)/);
                return parts ? `<div class="log-line"><span class="log-time">${parts[1]}</span>${parts[2]}</div>` : `<div>${l}</div>`;
            }).reverse().join('');
        },

        updateStatus(statusText) {
            const el = document.getElementById('xs-status');
            const btn = document.getElementById('xs-toggle-btn');
            if (STORE.isPaused) {
                if(el) el.innerText = "â›” å·²æš‚åœ";
                if(btn) { btn.className = "xs-btn btn-start"; btn.innerText = "â–¶ ç»§ç»­"; }
            } else {
                if(el) el.innerText = statusText || "âš¡ è¿è¡Œä¸­";
                if(btn) { btn.className = "xs-btn btn-pause"; btn.innerText = "â¸ æš‚åœ"; }
            }
        },
        
        updateExpiry(date) {
            const formatted = formatDate(date);
            STORE.expiryDate = formatted;
            const el = document.getElementById('xs-expiry');
            if(el) el.innerText = formatted;
        }
    };

    //===================== é€»è¾‘æ§åˆ¶å™¨ ======================//

    UI.init();

    if (STORE.isPaused) {
        UI.log("è„šæœ¬å·²æš‚åœï¼Œåœæ­¢æ‰§è¡Œæ“ä½œã€‚");
        return;
    }

    const bjTime = getBeijingDate();
    const isLoginUrl = location.href.includes("/login/xvps");

    // --- è°ƒåº¦é€»è¾‘ ---
    if (isLoginUrl) {
        if (STORE.forceRun) {
            UI.log("ğŸš€ æ£€æµ‹åˆ°å¼ºåˆ¶è¿è¡ŒæŒ‡ä»¤ï¼Œè·³è¿‡è°ƒåº¦æ£€æŸ¥ï¼");
            STORE.forceRun = false;
        } else {
            if (STORE.nextRunDate && bjTime.dateStr < STORE.nextRunDate) {
                UI.updateStatus("â³ é¢„çº¦ç­‰å¾…");
                UI.log(`â­ï¸ å·²é¢„çº¦äº [${STORE.nextRunDate}] ç»­æœŸï¼Œä»Šæ—¥è·³è¿‡ã€‚`);
                setTimeout(() => location.reload(), 3600 * 1000 * 4); 
                return;
            }

            if (STORE.lastRunDate === bjTime.dateStr) {
                UI.updateStatus("ğŸ’¤ å¾…æœºä¸­");
                UI.log(`ä»Šæ—¥ (${bjTime.dateStr}) ä»»åŠ¡å·²å¤„ç†`); 
                setTimeout(() => location.reload(), 3600 * 1000); 
                return;
            }

            // âš ï¸ å·²ç§»é™¤æ¯æ—¥ 9 ç‚¹çš„åˆ¤æ–­ï¼Œåªè¦æ—¥æœŸç¬¦åˆï¼Œç«‹å³è¿è¡Œ
            UI.log("âš¡ æ—¥æœŸç¬¦åˆï¼Œç«‹å³å¼€å§‹æ‰§è¡Œä»»åŠ¡ï¼");
        }
    }

    // --- ä¸šåŠ¡é€»è¾‘è·¯ç”± ---

    // â‘  ç™»å½•é¡µé¢
    if (location.href.includes("/login/xvps")) {
        UI.log("æ£€æµ‹åˆ°ç™»å½•é¡µé¢ï¼Œå‡†å¤‡ç™»å½•...");
        await wait(1000);
        const emailInput = document.querySelector("input[name='memberid']");
        const passInput = document.querySelector("input[name='user_password']");
        const submitBtn = document.querySelector("input[type='submit']");
        if (emailInput && passInput && submitBtn) {
            if (!CONFIG.EMAIL || !CONFIG.PASSWORD) {
                 UI.log("âŒ é”™è¯¯ï¼šè¯·åœ¨è„šæœ¬é…ç½®ä¸­å¡«å…¥è´¦å·å¯†ç ï¼");
                 return;
            }
            emailInput.value = CONFIG.EMAIL;
            passInput.value = CONFIG.PASSWORD;
            submitBtn.click();
        }
    }

    // â‘¡ é¦–é¡µ
    else if (location.href.includes("/xapanel/xvps/index")) {
        UI.log("é¦–é¡µ: ç­‰å¾…æœåŠ¡å™¨çŠ¶æ€å˜ä¸º [ç¨¼åƒä¸­]...");
        
        let runningStatus = null;
        for (let i = 0; i < 120; i++) { 
            const statusDivs = Array.from(document.querySelectorAll('div.on'));
            runningStatus = statusDivs.find(el => el.innerText.includes('ç¨¼åƒä¸­'));
            if (runningStatus) {
                UI.log("âœ… æ£€æµ‹åˆ° [ç¨¼åƒä¸­] çŠ¶æ€ï¼Œå‡†å¤‡æ‰§è¡Œ...");
                break;
            }
            await wait(1000);
        }

        if (!runningStatus) UI.log("âš ï¸ è¶…æ—¶æœªæ£€æµ‹åˆ° [ç¨¼åƒä¸­] çŠ¶æ€ã€‚");

        const exactDate = extractExactExpiry();
        if (exactDate) {
            UI.updateExpiry(exactDate);
            UI.log(`ğŸ“… åˆ©ç”¨æœŸé™: ${exactDate}`); 
        }

        if (STORE.lastRunDate === bjTime.dateStr && !STORE.forceRun) {
            UI.log("âœ… ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼Œåœæ­¢é‡å¤è·³è½¬ã€‚");
            UI.log("ğŸ’¤ 3ç§’åè¿”å›ç™»å½•é¡µå¾…æœº...");
            await wait(3000);
            location.href = CONFIG.LOGIN_URL;
            return;
        }

        UI.log("ğŸ” æ­£åœ¨è‡ªåŠ¨å¯»æ‰¾è¯¦æƒ…é¡µé“¾æ¥...");
        const detailLink = document.querySelector("a[href*='/server/detail?id=']");
        if (detailLink) {
            const foundId = detailLink.href.match(/id=(\d+)/)[1];
            UI.log(`âœ… æ‰¾åˆ°æœåŠ¡å™¨ ID: ${foundId}ï¼Œè·³è½¬ä¸­...`);
            await wait(500); 
            detailLink.click();
        } else {
            UI.log("âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•æœåŠ¡å™¨è¯¦æƒ…é“¾æ¥ï¼");
            const manageBtn = Array.from(document.querySelectorAll("a")).find(el => el.innerText.includes("VPSç®¡ç†"));
            if (manageBtn) {
                UI.log("ğŸ”„ å°è¯•ç‚¹å‡» [VPSç®¡ç†] æŒ‰é’®...");
                manageBtn.click();
            }
        }
    }

    // â‘¢ è¯¦æƒ…é¡µ
    else if (location.href.includes("/server/detail")) {
        UI.log("è¯¦æƒ…é¡µ: æ£€æŸ¥çŠ¶æ€...");
        await wait(1000);

        if (STORE.lastRunDate === bjTime.dateStr && !STORE.forceRun) {
            UI.log("âœ… æ£€æµ‹åˆ°ä»Šæ—¥ä»»åŠ¡å·²å®Œæˆï¼Œåœæ­¢æ“ä½œã€‚");
            setTimeout(() => { location.href = CONFIG.LOGIN_URL; }, 2000);
            return;
        }

        const exactDate = extractExactExpiry();
        if (exactDate) {
            UI.updateExpiry(exactDate);
            UI.log(`ğŸ“… è¯¦æƒ…é¡µæŠ“å–åˆ°æœŸæ—¶é—´: ${exactDate}`);
        }

        await wait(1000);

        // ğŸŸ¢ æ™ºèƒ½æ’æœŸæ•è· (è¯¦æƒ…é¡µ)
        if (document.body.innerText.includes("åˆ©ç”¨æœŸé™ã®1æ—¥å‰ã‹ã‚‰") || document.body.innerText.includes("æ›´æ–°æ‰‹ç¶šããŒå¯èƒ½")) {
            UI.log("âš ï¸ æç¤º: æœªåˆ°ç»­æœŸæ—¶é—´ (éœ€æå‰1å¤©)");
            
            const nextDate = extractNextAllowedDate();
            if (nextDate) {
                STORE.nextRunDate = nextDate;
                UI.log(`ğŸ“… å·²è®¾ç½®é¢„çº¦ï¼šä¸‹æ¬¡è¿è¡Œæ—¶é—´é”å®šä¸º [${nextDate}]`);
            }

            if (STORE.lastRunDate !== bjTime.dateStr) sendTg(`âš ï¸ æœªåˆ°ç»­æœŸæ—¶é—´ã€‚`); 
            STORE.lastRunDate = getBeijingDate().dateStr; 
            setTimeout(() => { location.href = CONFIG.LOGIN_URL; }, 5000);
            return;
        }

        const updateBtn = Array.from(document.querySelectorAll("a, button"))
            .find(el => el.innerText.trim() === "æ›´æ–°ã™ã‚‹");
        if (updateBtn) updateBtn.click();
        else UI.log("âš ï¸ æœªæ‰¾åˆ°æ›´æ–°æŒ‰é’®");
    }

    // â‘£ é€‰æ‹©é¡µ
    else if (location.href.includes("/freevps") && (location.href.includes("/compare") || location.href.includes("/extend/index"))) {
        UI.log("é€‰æ‹©é¡µ: ç¡®è®¤ç»­æœŸé€‰é¡¹...");
        await wait(2000);
        const continueBtn = Array.from(document.querySelectorAll("a, button, input[type='submit']"))
            .find(el => {
                const txt = (el.innerText || el.value || "").replace(/\s/g, "");
                return txt.includes("ç„¡æ–™VPS") && txt.includes("ç¶™ç¶š");
            });
        if (continueBtn) continueBtn.click();
    }

    // â‘¤ éªŒè¯/ç¡®è®¤/æ‰§è¡Œé¡µ
    else if (location.href.includes("/freevps/extend")) {
        UI.log("ğŸŒ¸ è¿›å…¥å¤„ç†æµç¨‹..."); 
        await wait(1000);

        const newExpiry = extractNewExpiryFromConf();
        if (newExpiry) {
            UI.updateExpiry(newExpiry);
            UI.log(`ğŸ“… æ›´æ–°åçš„åˆ©ç”¨æœŸé™: ${newExpiry}`);
        }

        // ğŸŸ¢ æ™ºèƒ½æ’æœŸæ•è· (éªŒè¯é¡µ)
        if (document.body.innerText.includes("åˆ©ç”¨æœŸé™ã®1æ—¥å‰ã‹ã‚‰") || document.body.innerText.includes("æ›´æ–°æ‰‹ç¶šããŒå¯èƒ½")) {
            UI.log("âš ï¸ æç¤º: æœªåˆ°ç»­æœŸæ—¶é—´");
            
            const nextDate = extractNextAllowedDate();
            if (nextDate) {
                STORE.nextRunDate = nextDate;
                UI.log(`ğŸ“… å·²è®¾ç½®é¢„çº¦ï¼šä¸‹æ¬¡è¿è¡Œæ—¶é—´é”å®šä¸º [${nextDate}]`);
            }

            if (STORE.lastRunDate !== bjTime.dateStr) sendTg(`âš ï¸ æœªåˆ°ç»­æœŸæ—¶é—´ã€‚`); 
            STORE.lastRunDate = getBeijingDate().dateStr;
            setTimeout(() => { location.href = CONFIG.LOGIN_URL; }, 5000);
            return; 
        }

        UI.log("ğŸ” æ­£åœ¨ç­‰å¾…éªŒè¯ç å›¾ç‰‡åŠ è½½...");
        let captchaImg = null;
        for (let i = 0; i < 20; i++) { 
            captchaImg = document.querySelector("img[src^='data:image']");
            if (captchaImg) break;
            await wait(500);
        }

        if (captchaImg) {
            UI.log("âœ… å‘ç°éªŒè¯ç ï¼Œæ‰§è¡ŒOCR...");
            const code = await ocrSolve(captchaImg.src);
            if (code && code.length >= 4) {
                const input = document.querySelector("input[type='text']") || document.querySelector("[placeholder*='ä¸Šã®ç”»åƒ']");
                if (input) {
                    input.value = code;
                    input.dispatchEvent(new Event('input', { bubbles: true }));
                    UI.log(`âœ… è‡ªåŠ¨å¡«å…¥: ${code}`);
                }
            } else {
                UI.log("âŒ OCRæ— æ³•è¯†åˆ«ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ã€‚");
            }
        } else {
            UI.log("â„¹ï¸ æœ¬é¡µæ— éªŒè¯ç  (æˆ–æ˜¯ç¡®è®¤é¡µ)ï¼Œç›´æ¥å¯»æ‰¾æŒ‰é’®...");
        }

        await wait(1000);

        let loopCount = 0;
        let hasClicked = false;
        
        const processInterval = setInterval(() => {
            if (hasClicked) { clearInterval(processInterval); return; }
            loopCount++;

            const turnstileIframe = document.querySelector("iframe[src*='turnstile']");
            if (turnstileIframe && loopCount % 5 === 0) try { turnstileIframe.click(); } catch(e){}

            const inputField = document.querySelector("input[type='text']") || document.querySelector("[placeholder*='ä¸Šã®ç”»åƒ']");
            if (inputField) {
                const currentVal = inputField.value;
                if (!currentVal || currentVal.length < 4) {
                    if (loopCount % 5 === 0) UI.log("â³ ç­‰å¾…éªŒè¯ç å¡«å…¥...");
                    if (loopCount >= 180) { 
                         clearInterval(processInterval);
                         UI.log("âŒ è¶…æ—¶æœªå¡«å…¥ï¼Œåœæ­¢ã€‚");
                    }
                    return; 
                }
            }

            let validSubmitBtn = document.getElementById('submit_button');
            if (!validSubmitBtn) {
                const candidates = Array.from(document.querySelectorAll("input[type='submit'], button, a.btn"));
                validSubmitBtn = candidates.find(el => {
                    const text = (el.value || el.innerText || "").replace(/\s+/g, "");
                    return text.includes("ç¶™ç¶š") || 
                           text.includes("æ›´æ–°") || 
                           text.includes("ç¢ºå®š") || 
                           text.includes("ç„¡æ–™VPS") ||
                           el.classList.contains('btn--primary');
                });
            }

            if (validSubmitBtn) {
                hasClicked = true;
                clearInterval(processInterval);
                UI.log(`ğŸš€ æ‰¾åˆ°æŒ‰é’® [${validSubmitBtn.id || validSubmitBtn.value || "Button"}]ï¼Œç‚¹å‡»æäº¤...`);
                validSubmitBtn.style.border = "5px solid green";
                
                setTimeout(() => {
                    validSubmitBtn.click();
                    UI.log("âœ… ç‚¹å‡»åŠ¨ä½œå®Œæˆ...");
                    
                    STORE.nextRunDate = ""; 
                    STORE.lastRunDate = getBeijingDate().dateStr;
                    sendTg("âœ… ç»­æœŸæäº¤æ“ä½œå·²æ‰§è¡Œï¼è¯·æ˜æ—¥ç¡®è®¤çŠ¶æ€ã€‚");
                    
                    setTimeout(() => { location.href = CONFIG.LOGIN_URL; }, 5000);
                }, 300);
            }

            if (loopCount >= 200) clearInterval(processInterval);
        }, 1000);
    } 

    // â‘¦ å®Œæˆé¡µ
    else if (location.href.includes("complete") || document.body.innerText.includes("å®Œäº†")) {
         STORE.lastRunDate = getBeijingDate().dateStr;
         sendTg("âœ… ç»­æœŸæµç¨‹åœ†æ»¡å®Œæˆï¼");
         UI.log("ğŸŒ¸ æµç¨‹ç»“æŸï¼Œè¿”å›å¾…æœºã€‚");
         setTimeout(() => { location.href = CONFIG.LOGIN_URL; }, 5000);
    }
})();